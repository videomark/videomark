#!/bin/bash
set -euo pipefail

PUBLISH_DIR=dist
DIR_CHROME=${PUBLISH_DIR}/${MODE}-chrome
DIR_FIREFOX=${PUBLISH_DIR}/${MODE}-firefox

log() {
  echo "$0:" "$@"
}

cd -- "$(dirname -- "$0")/.."

log "Build mode is ${MODE}"
log "Working directory is $(pwd)"

log "Cleaning up..."
rm -rf -- "${PUBLISH_DIR}"

log "Building extension..."
mkdir -p -- "${DIR_CHROME}"
MODE=${MODE} vite build --outDir "${DIR_CHROME}"

# Firefox はマニフェストファイルに互換性がないため別途コピーで対応
log "Packaging Firefox extension..."
cp -r ${DIR_CHROME} ${DIR_FIREFOX}
mv ${DIR_FIREFOX}/manifest-firefox.json ${DIR_FIREFOX}/manifest.json
rm ${DIR_FIREFOX}/request_rules.json
(cd -- "${DIR_FIREFOX}" && zip -q -r "../vm-${MODE}-firefox.xpi" . -x ".DS_Store")

log "Packaging Chrome extension..."
rm ${DIR_CHROME}/manifest-firefox.json ${DIR_CHROME}/background.html
(cd -- "${DIR_CHROME}" && zip -q -r "../vm-${MODE}-chrome.zip" . -x ".DS_Store")

log "Build complete. Extension is available under ${PUBLISH_DIR} directory."
